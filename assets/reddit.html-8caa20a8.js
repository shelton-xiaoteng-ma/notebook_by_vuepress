import{_ as t,Y as p,Z as o,a0 as s,a1 as n,a2 as e,$ as i,a4 as c,E as l}from"./framework-957baa9a.js";const r={},u=s("h1",{id:"使用praw获取reddit内容",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#使用praw获取reddit内容","aria-hidden":"true"},"#"),n(" 使用praw获取reddit内容")],-1),d={href:"https://support.reddithelp.com/hc/en-us/articles/16160319875092-Reddit-Data-API-Wiki",target:"_blank",rel:"noopener noreferrer"},m={href:"https://praw.readthedocs.io/en/stable/getting_started/quick_start.html",target:"_blank",rel:"noopener noreferrer"},k=c(`<h2 id="reddit-app" tabindex="-1"><a class="header-anchor" href="#reddit-app" aria-hidden="true">#</a> reddit app</h2><p>注册地址: https://www.reddit.com/prefs/apps</p><p>限制: 600次/10min, 通过接口headers的<code>x-ratelimit-used/x-ratelimit-reset/x-ratelimit-remaining</code>限制访问速度, 注册多个app可以提高速度</p><h2 id="praw" tabindex="-1"><a class="header-anchor" href="#praw" aria-hidden="true">#</a> PRAW</h2><h3 id="关于429报错" tabindex="-1"><a class="header-anchor" href="#关于429报错" aria-hidden="true">#</a> 关于429报错</h3><p>当时临界点处理不太严谨, 还是可能触发429, 所以需要修改下源码</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># /lib/python3.9/site-packages/prawcore/rate_limit.py</span>
<span class="token comment"># 当剩余次数小于3次, 就等待重置, 避免触发429请求</span>
<span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response_headers<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    self<span class="token punctuation">.</span>reset_timestamp <span class="token operator">=</span> now <span class="token operator">+</span> seconds_to_reset

    <span class="token comment"># 增加以下内容</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>remaining <span class="token operator">&lt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>next_request_timestamp <span class="token operator">=</span> self<span class="token punctuation">.</span>reset_timestamp
        <span class="token keyword">return</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关于并发" tabindex="-1"><a class="header-anchor" href="#关于并发" aria-hidden="true">#</a> 关于并发</h3><p>因为reddit通过app限制并发, 可以创建多个app, 多进程的形式进行, praw不是线程安全</p><h3 id="关于评论数" tabindex="-1"><a class="header-anchor" href="#关于评论数" aria-hidden="true">#</a> 关于评论数</h3><p>reddit会对一些评论做隐藏/折叠操作, 所以实际获取到评论数可能会少于展示的评论数</p><h3 id="demo" tabindex="-1"><a class="header-anchor" href="#demo" aria-hidden="true">#</a> Demo</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token comment"># 创建实例</span>
<span class="token keyword">import</span> praw

reddit <span class="token operator">=</span> praw<span class="token punctuation">.</span>Reddit<span class="token punctuation">(</span>
    client_id<span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
    client_secret<span class="token operator">=</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">,</span>
    password<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
    user_agent<span class="token operator">=</span><span class="token string">&quot;xxx (by u/USERNAME)&quot;</span><span class="token punctuation">,</span>
    username<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token comment"># 获取popular最新的100个帖子 hot/top</span>
<span class="token keyword">for</span> submission <span class="token keyword">in</span> reddit<span class="token punctuation">.</span>subreddit<span class="token punctuation">(</span><span class="token string">&quot;popular&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>new<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>submission<span class="token punctuation">.</span>title<span class="token punctuation">)</span>

<span class="token comment"># 返回新讨论, 最开始返回100</span>
<span class="token keyword">for</span> submission <span class="token keyword">in</span> reddit<span class="token punctuation">.</span>subreddit<span class="token punctuation">(</span><span class="token string">&quot;popular&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span>submissions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>submission<span class="token punctuation">)</span>

<span class="token comment"># 持续取回新评论</span>
<span class="token comment"># https://praw.readthedocs.io/en/stable/code_overview/other/subredditstream.html#praw.models.reddit.subreddit.SubredditStream</span>
<span class="token keyword">for</span> comment <span class="token keyword">in</span> reddit<span class="token punctuation">.</span>subreddit<span class="token punctuation">(</span><span class="token string">&quot;popular&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span>comments<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span>

<span class="token comment"># 批量获取评论</span>
submission <span class="token operator">=</span> reddit<span class="token punctuation">.</span>submission<span class="token punctuation">(</span><span class="token string">&quot;15ztk07&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># submission.comments 包含MoreComments, 使用replace_more可以替换MoreComments为comments</span>
submission<span class="token punctuation">.</span>comments<span class="token punctuation">.</span>replace_more<span class="token punctuation">(</span>limit<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
comments <span class="token operator">=</span> submission<span class="token punctuation">.</span>comments<span class="token punctuation">.</span><span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 评论数验证, 实际获取到评论数可能会少于展示的评论数</span>
submission<span class="token punctuation">.</span>num_comments <span class="token operator">==</span> <span class="token builtin">len</span><span class="token punctuation">(</span>comments<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13);function v(b,h){const a=l("ExternalLinkIcon");return p(),o("div",null,[u,s("p",null,[n("reddit本身提供官方接口访问"),s("a",d,[n("Reddit Data API Wiki"),e(a)]),n(", 并且从2023-07开始对请求做了限制")]),s("p",null,[n("这里借助"),s("a",m,[n("PRAW"),e(a)]),n("请求")]),i(" more "),k])}const w=t(r,[["render",v],["__file","reddit.html.vue"]]);export{w as default};
